# Task ï¼»ä¿¡ä»¶ï¼½å„ªæƒ ç™¼æ”¾é€šçŸ¥ä¿¡
[Jira](https://104corp.atlassian.net/browse/GIVERFARM-1556)

## TODO


## éœ€æ±‚&è¦å‰‡
éš±è—é¡å‹å„ªæƒ åŠµç™¼æ”¾æ™‚ï¼ŒåŒæ™‚é€šçŸ¥æœƒå“¡

å› ç‚ºç™¼é€è¡Œç‚ºå¯ä»¥é‡è¤‡æ“ä½œï¼Œæ‰€ä»¥ä¸€æ¬¡çš„æ¸…å–®è£¡å¯èƒ½åŒ…å«ä»¥ä¸‹ä¸‰ç¨®ç”¨æˆ¶
1.æ²’ç™¼é€éå„ªæƒ åˆ¸ > ç™¼åˆ¸ä¸¦é€šçŸ¥
2.æœ‰ç™¼é€éå„ªæƒ åˆ¸ï¼Œä½†æ²’å¯„éä¿¡ > ä¸å¯„ä¿¡é€šçŸ¥
3.æœ‰ç™¼é€éå„ªæƒ åˆ¸ï¼Œæœ‰å¯„éä¿¡ > ä¸å¯„ä¿¡é€šçŸ¥

## æµç¨‹
### ä¸»è¦ æµç¨‹ä¸€
1. CRMå¾Œå°è¨­å®šç™¼æ”¾å„ªæƒ å·
2. è‹¥è¨­å®šéœ€è¦ç™¼é€å‰‡ç™¼é€é€šçŸ¥ä¿¡ 

## ç¾æ³ç›¤é»
1. CRM å–å¾—å„ªæƒ åˆ¸æ¸…å–®
POST https://crm.nabi.104dc-dev.com/api/crm/coupon/v2/list
2. CRM å–å¾—å„ªæƒ åˆ¸è©³ç´°è³‡æ–™
GET https://crm.nabi.104dc-dev.com/api/crm/coupon/7875b890-cfe8-4d0e-aa34-56f61a55a018
3.1 CRM æ‰‹å‹•è¼¸å…¥æŒ‡å®špidç™¼é€å„ªæƒ åˆ¸
POST https://crm.nabi.104dc-dev.com/api/crm/coupon/assign_manual
3.2 CRM æª”æ¡ˆåŒ¯å…¥æŒ‡å®špidç™¼é€å„ªæƒ åˆ¸
POST https://crm.nabi.104dc-dev.com/api/crm/coupon/assign_batch

## é–‹ç™¼ç¯„ç–‡
### å¾Œç«¯
#### å¾Œç«¯é–‹ç™¼æµç¨‹
å› ç‚ºæœ‰ä½¿ç”¨ruffï¼Œé¿å…é–‹ç™¼å¾Œæ··åˆäº†éœ€æ±‚èˆ‡æ ¼å¼èª¿æ•´
å…ˆç›¤é»æœƒç•°å‹•çš„æª”æ¡ˆï¼Œå…ˆç”¨ruffèª¿æ•´æ ¼å¼ï¼Œcommitå¾Œå†é€²è¡Œéœ€æ±‚é–‹ç™¼
1. ç›¤é»æª”æ¡ˆ
    api_crm/coupon/views.py
    api_crm/coupon/actions.py
    api_purchase/coupon/util.py
    api_ap/purchase/tasks.py
    api_ap/mail/mail_tasks.py
    api_ap/mail/service.py
    services/cache/actions.py
2. ç”¨ruffèª¿æ•´é€™äº›æª”æ¡ˆæ ¼å¼
3. é–‹å§‹é–‹ç™¼éœ€æ±‚

#### å¾Œç«¯ ç™¼ä¿¡è¦å‰‡

#### èª¿æ•´ post /coupon/assign_manual api
1. apiå¢åŠ è¦åŒæ™‚ç™¼ä¿¡çš„åƒæ•¸
2. å°æ‡‰çš„actionå‡½å¼åŠ å…¥ç™¼ä¿¡åƒæ•¸
3. è‹¥æœ‰è¨­å®šç™¼é€é€šçŸ¥ä¿¡ï¼Œå‰‡ç™¼é€é€šçŸ¥ä¿¡ï¼ŒåŠ åœ¨receive_coupon_unlimitå¾Œé¢ï¼Œé€édramatiq TaskéåŒæ­¥å¯„é€
4. å¯„ä¿¡æµç¨‹åƒè€ƒ emit_course_favorite_promo_mail functionçš„petternèˆ‡å°æ‡‰functionçš„æ”¾ç½®æ–¹å¼ï¼Œå¦‚æŠŠå–å¾—è³‡æ–™çš„functionæ”¾åœ¨service.pyï¼Œèˆ‡cacheæ”¾åœ¨cacheå°ˆç”¨çš„æª”æ¡ˆç­‰ï¼Œå¯„ä¿¡çš„functionæ”¾åœ¨api_ap/mail/link_service.py
5. æ•´å°ä¿¡éœ€è¦çš„è³‡è¨Šé™¤äº†èª²ç¨‹è³‡è¨Šä»¥å¤–æœ‰ç”¨æˆ¶å§“åã€å„ªæƒ åŠµè³‡è¨Šã€1~6å ‚èª²ç¨‹çµ„æˆä»¥ä¸‹è³‡è¨Š
   - ä¿¡ä»¶ä¸»æ—¨: å—¨ï¼Œ{nickname}ï¼Œä½ æ”¶åˆ°äº†ä¸€å¼µå°ˆå±¬å„ªæƒ åŠµ!
   - ä¿¡ä»¶é è¦½å…§å®¹: æœ‰ä¸€å¼µå°ˆå±¬å„ªæƒ æ·»åŠ è‡³ä½ çš„å¸³è™Ÿè£¡å›‰ï¼Œå¿«ä¾†çœ‹çœ‹å§!
   - ä½¿ç”¨æœŸé™: yyyy/mm/dd
   - å„ªæƒ å…§å®¹: ${discount}å…ƒ æˆ– ${discount}æŠ˜
6. templateåƒè€ƒå°šæœªæº–å‚™å¥½ï¼Œæˆ‘æœƒè‡ªå·±è™•ç†ï¼Œå…ˆå¯«å¥½å°æ‡‰ç¨‹å¼ï¼Œç­‰templateæº–å‚™å¥½å¾Œå†èª¿æ•´ï¼Œå…ˆå¹«æˆ‘æŠŠæ¸²æŸ“ç”¨çš„åƒæ•¸ç‰©ä»¶å°å‡ºä¾†å³å¯ï¼Œä¸ç”¨è™•ç†
   - template name => coupon_assign_promote.html
   - æ”¾é€²templateçš„åƒæ•¸ç‰©ä»¶è«‹åƒè€ƒå…¶ä»–mailç”¨çš„è®Šæ•¸åç¨±
7. å„ªæƒ åˆ¸è³‡è¨Š(table: nabi_coupon)
    - å„ªæƒ å…§å®¹(æŠ˜æ•¸or é‡‘é¡)
    - å„ªæƒ åŠµåç¨±
    - ä½¿ç”¨æœŸé™
8. å–å¾—ä¿¡ä»¶éœ€è¦çš„èª²ç¨‹ï¼
   - å„ªæƒ åˆ¸é©ç”¨
     - èª²ç¨‹é‡‘é¡ > 0 table:nabi_3rd_course.price
     - åœ¨nabiè²©å”® table:nabi_3rd_course.sale_site=1
     - å„ªæƒ åˆ¸é¡å‹ table:nabi_coupon.coupon_type
       - é¡å‹ 1: ä¾å» å•†
       - é¡å‹ 2: ä¾è¨­å®šèª²ç¨‹ table:nabi_coupon_resource
     - è‹¥æ˜¯å¯¦é«”èª²ç¨‹éœ€é¡å¤–åˆ¤æ–·
       - æ˜¯å¦è¶…éå ±åæ™‚é–“ç¯„åœ nabi_3rd_course.signup_deadline < ä»Šå¤©ï¼Ÿå¹¾å¤©å‰ï¼Ÿ
       - æ˜¯å¦è¶…éå ±åäººæ•¸ nabi_vouchar.status=0 count > 0
     - æ¿¾æ‰å¤±æ•ˆèª²ç¨‹ nabi_resource.disable==0
     - æ¿¾æ‰å¤±æ•ˆå» å•†çš„èª²ç¨‹ nabi_3rd_provider.disable==0
   - ä¾ç…§éå»ä¸ƒå¤©èª²ç¨‹ç€è¦½äººæ•¸æ’åº view_count_7 æ’åºæ’ˆå‡ºæœ€å¤šçš„6ç­†
   - cacheä¿¡ä»¶èª²ç¨‹12å°æ™‚ï¼Œå¯„ä¿¡æ™‚ä¸ç”¨é‡è¤‡æ’ˆå–ï¼Œnabi:mail:coupon_assign_promote:{coupon_id}
9.   å¯„ä¿¡ç©ä¹Ÿè¦å¯«å…¥mail logï¼Œåƒè€ƒemit_course_favorite_promo_mail
- è«‹æ³¨æ„åŸ·è¡Œçš„æ•ˆèƒ½è­°é¡Œï¼ŒæŠ“å–è³‡æ–™èªæ³•æˆ–modelè«‹å¹«æˆ‘æª¢æŸ¥indexï¼Œç›¡é‡åœ¨ç•¶å‰ç‹€æ…‹æœ€ä½³åŒ–
- ç›¡é‡å°‘ç¯„åœçš„ç•°å‹•ç¨‹å¼ç¢¼ï¼Œé¿å…å½±éŸ¿å…¶ä»–åŠŸèƒ½
- é€™æ¬¡çš„éœ€æ±‚æ²’æœ‰éœ€è¦å¦é–‹æ–°æª”æ¡ˆ

æ‰‹å‹•èª¿æ•´
utmç›¸é—œ
é è¦½å…§å®¹å¯«æ­»
<p style="display:none;font-size:0;max-height:0;width:0;line-height:0;mso-hide:all">{{data.mail_content.courses[0].title}}{% for course in data.mail_content.courses[1:3] %}ï½œ{{course.title}}{% endfor %}  ğŸ‘‰ ç«‹å³æŸ¥çœ‹è³¼ç‰©è»Š</p>

#### èª¿æ•´ /coupon/assign_batch
1. apiå¢åŠ è¦åŒæ™‚ç™¼ä¿¡çš„åƒæ•¸
2. åŠ å…¥actionåƒæ•¸
3. è‹¥æœ‰è¨­å®šç™¼é€é€šçŸ¥ä¿¡ï¼Œå‰‡ç™¼é€é€šçŸ¥ä¿¡ï¼Œè¦åŠ å…¥ä¸­ç¹¼çš„Redisè³‡æ–™
4. å¾ŒçºŒå–å‡ºè³‡æ–™çš„é‹ä½œä¹Ÿè¦æŠŠç™¼ä¿¡åƒæ•¸passä¸‹å»åˆ°ç™¼ä¿¡å±¤
5. ä¿¡ä»¶èª²ç¨‹é‹ä½œåŒ /coupon/assign_manual

### å‰ç«¯
#### èª¿æ•´ä¸²æ¥ /coupon/assign_manual
#### èª¿æ•´ä¸²æ¥ /coupon/assign_batch

### ä¸Šç‰ˆæ³¨æ„

### é©—æ”¶æ³¨æ„

### å»¶ä¼¸è­°é¡Œ

# prompt

# Log
========================================================