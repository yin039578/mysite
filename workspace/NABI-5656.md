# Task ［信件］優惠發放通知信
[Jira](https://104corp.atlassian.net/browse/GIVERFARM-1556)

## TODO


## 需求&規則
隱藏類型優惠劵發放時，同時通知會員

因為發送行為可以重複操作，所以一次的清單裡可能包含以下三種用戶
1.沒發送過優惠券 > 發券並通知
2.有發送過優惠券，但沒寄過信 > 不寄信通知
3.有發送過優惠券，有寄過信 > 不寄信通知

## 流程
### 主要 流程一
1. CRM後台設定發放優惠卷
2. 若設定需要發送則發送通知信 

## 現況盤點
1. CRM 取得優惠券清單
POST https://crm.nabi.104dc-dev.com/api/crm/coupon/v2/list
2. CRM 取得優惠券詳細資料
GET https://crm.nabi.104dc-dev.com/api/crm/coupon/7875b890-cfe8-4d0e-aa34-56f61a55a018
3.1 CRM 手動輸入指定pid發送優惠券
POST https://crm.nabi.104dc-dev.com/api/crm/coupon/assign_manual
3.2 CRM 檔案匯入指定pid發送優惠券
POST https://crm.nabi.104dc-dev.com/api/crm/coupon/assign_batch

## 開發範疇
### 後端
#### 後端開發流程
因為有使用ruff，避免開發後混合了需求與格式調整
先盤點會異動的檔案，先用ruff調整格式，commit後再進行需求開發
1. 盤點檔案
    api_crm/coupon/views.py
    api_crm/coupon/actions.py
    api_purchase/coupon/util.py
    api_ap/purchase/tasks.py
    api_ap/mail/mail_tasks.py
    api_ap/mail/service.py
    services/cache/actions.py
2. 用ruff調整這些檔案格式
3. 開始開發需求

#### 後端 發信規則

#### 調整 post /coupon/assign_manual api
1. api增加要同時發信的參數
2. 對應的action函式加入發信參數
3. 若有設定發送通知信，則發送通知信，加在receive_coupon_unlimit後面，透過dramatiq Task非同步寄送
4. 寄信流程參考 emit_course_favorite_promo_mail function的pettern與對應function的放置方式，如把取得資料的function放在service.py，與cache放在cache專用的檔案等，寄信的function放在api_ap/mail/link_service.py
5. 整封信需要的資訊除了課程資訊以外有用戶姓名、優惠劵資訊、1~6堂課程組成以下資訊
   - 信件主旨: 嗨，{nickname}，你收到了一張專屬優惠劵!
   - 信件預覽內容: 有一張專屬優惠添加至你的帳號裡囉，快來看看吧!
   - 使用期限: yyyy/mm/dd
   - 優惠內容: ${discount}元 或 ${discount}折
6. template參考尚未準備好，我會自己處理，先寫好對應程式，等template準備好後再調整，先幫我把渲染用的參數物件印出來即可，不用處理
   - template name => coupon_assign_promote.html
   - 放進template的參數物件請參考其他mail用的變數名稱
7. 優惠券資訊(table: nabi_coupon)
    - 優惠內容(折數or 金額)
    - 優惠劵名稱
    - 使用期限
8. 取得信件需要的課程－
   - 優惠券適用
     - 課程金額 > 0 table:nabi_3rd_course.price
     - 在nabi販售 table:nabi_3rd_course.sale_site=1
     - 優惠券類型 table:nabi_coupon.coupon_type
       - 類型 1: 依廠商
       - 類型 2: 依設定課程 table:nabi_coupon_resource
     - 若是實體課程需額外判斷
       - 是否超過報名時間範圍 nabi_3rd_course.signup_deadline < 今天？幾天前？
       - 是否超過報名人數 nabi_vouchar.status=0 count > 0
     - 濾掉失效課程 nabi_resource.disable==0
     - 濾掉失效廠商的課程 nabi_3rd_provider.disable==0
   - 依照過去七天課程瀏覽人數排序 view_count_7 排序撈出最多的6筆
   - cache信件課程12小時，寄信時不用重複撈取，nabi:mail:coupon_assign_promote:{coupon_id}
9.   寄信玩也要寫入mail log，參考emit_course_favorite_promo_mail
- 請注意執行的效能議題，抓取資料語法或model請幫我檢查index，盡量在當前狀態最佳化
- 盡量少範圍的異動程式碼，避免影響其他功能
- 這次的需求沒有需要另開新檔案

手動調整
utm相關
預覽內容寫死
<p style="display:none;font-size:0;max-height:0;width:0;line-height:0;mso-hide:all">{{data.mail_content.courses[0].title}}{% for course in data.mail_content.courses[1:3] %}｜{{course.title}}{% endfor %}  👉 立即查看購物車</p>

#### 調整 /coupon/assign_batch
1. api增加要同時發信的參數
2. 加入action參數
3. 若有設定發送通知信，則發送通知信，要加入中繼的Redis資料
4. 後續取出資料的運作也要把發信參數pass下去到發信層
5. 信件課程運作同 /coupon/assign_manual

### 前端
#### 調整串接 /coupon/assign_manual
#### 調整串接 /coupon/assign_batch

### 上版注意

### 驗收注意

### 延伸議題

# prompt

# Log
========================================================