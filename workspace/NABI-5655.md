# NABI-5655［信件］優惠倒數提醒信
[Jira](https://104corp.atlassian.net/browse/NABI-5655)

## 需求&規則
信件參考5656

 
## 流程
### 主要 AP觸發發信
### 主要 後台查詢發信紀錄
 
## 開發範疇

### 後端
#### AP發信
一個新的需求：要有一個每天跑一次的AP，透過一個API驅動
參考信件內容與處理請參考`sendCouponAssignLetter`api
流程如下
1. 取得要發信的優惠券清單與順序
   1. 取得N天後到期的優惠券，依照create_date,coupon_id排序，create_date先發的優先 > table:nabi_coupon end_date
   2. 日期計算，以3天為例：9/5到期 end_date可以是9/5 00:00, 也可以是9/5 23:59，為了簡化規則，這兩種情況都會是日期-3就會是9/2號發信
2. 依照優惠券優先序抓取發送名單
   1. 取得所有擁有可用但尚未使用的pid清單 > table:user_own_coupon use_state=0, disable=0, pid
   2. 執行發信流程
      1. 檢查User是否在七天內收過該信種，若有則跳過 > table:nabi_maillog mail_type, mail_date, pid
      2. 取得發信所需User資料
      3. 取得發信所需課程資料
      4. 發信並寫入log

#### 設定發信task schedule
1. 設定 run deck 每日中午12點發送優惠倒數提醒信 > 新的加入run deck方式
#### 後台查詢發信紀錄
1. 修改 api於api_ap/stats/views.py的get /mail_log_statistic api，加入統計需求

### 前端
#### 前端task1
#### 前端task2

### 上版注意

### 驗收注意

### 延伸議題

# prompt

# Log
========================================================
