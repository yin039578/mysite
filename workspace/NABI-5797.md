# Task [Java 翻寫] 共學教室相關機制信 N91, N92, N94
[Jira](https://104corp.atlassian.net/browse/NABI-5797)
TODO
1.驗證產信
2.修改機制
3.驗證新舊規格
4.code review

**Review兼盤點流程**
- N91 send_join_room 機制信
  - 串接點
    - room_apply_review: 共學人工審核
    - room_apply_auto_review_proc: 共學自動審核
  - 發信
    1. 傳入apply_id或room_id+pid > apply_id情境沒用到了，移除
    2. 取得教室成員人數，需排除創建人
    3. 預設信件內容為教室貼文，取得教室貼文數
       1. 若有貼文，用特定規則取得三篇po文
       2. 若無貼文，更改信件內容為熱門教室並取得四間熱門教室
    4. 取得教室預設圖
    5. 從ac取得收件者mail
    6. 從資料庫取得收件者與創建者資訊 > 移除創建者資訊，用不到
    7. 機敏資料解密：創建者姓名、收件者姓名、email > 移除創建者資訊，用不到
    8. 組成發信資料包
    9. 指定template發信
  - 測試
    -  
- N92 send_review_room_apply 排程信
  - 串接點: AP > rundeck 已串接 clz-api，從轉呼叫的地方變更串接方式
  - 發信
    1. 傳入room_id
    2. 取得教室資訊並確認教室狀態正常
    3. 取得待審核資料筆數
    4. 取得教室創建者和共同管理者pid
    5. 取得教室成員人數，需排除創建人
    6. 預設信件內容為教室貼文，取得教室貼文數
       1. 若有貼文，用特定規則取得三篇po文
       2. 若無貼文，更改信件內容為寫在設定檔之教學貼文
    7. 以教室創建者和共同管理者為收件者
       1. 從ac取得收件者mail 
       2. by收件人組成每人一個寄件資料包
    8. by收件者指定template發信
  - 測試
- N94 send_room_promote 排程信
  - 串接點: AP > rundeck 已串接 clz-api，從轉呼叫的地方變更串接方式
  - 發信
    1. 傳入room_id
    2. 確認是否為promote狀態的教室
       1. 若否則直接回應失敗
    3. 確認room狀態是否為正常
    4. 預設信件內容為教室貼文，是promot教室，必然有足夠貼文，不另做判斷
    5. 取得教室預設圖
    6. 從ac取得收件者mail，收件者為創建者
    7. 機敏資料解密
    8. 組成發信資料包
    9. 指定template發信
  - 測試
**多做的**
1.收納取得預設圖的連結 > post + course
2.收納取得預設圖的連結 > room
    1.修改api_mail/actions.py prepare_favorite_room_news_mailcontent取得預設圖的函式
3.修正mail_type 6,7顛倒的錯誤，後台顯示會兩邊反過來 >>> 前端要改
4.移除join room沒用到creator_name相關程式

code review
1. room apply要確認寄信成功才更新狀態 > 代表寄信可能不能用task執行，要直接跑並取得結果才能往下
2. v api_ap/mail/link_service.py 需要修正6,7對調議題
3. room_list_simple 好像重複的code，是之前其他分支的功能，不該在這邊以新修改出現，好怪，看rebase dev會不會消失
4. v 移除generate_post_default_image
5. v pop_max_by 中文說明，傳入資料list與lamda函式，取出清單內的資料用lamda算出最大值的第一個回傳
*. 移除測試的code，把發信註解拿掉，移除寫檔案程式

feat: NABI-5797 [Java 翻寫] 共學教室相關機制信 N91, N92, N94
1. 改寫N91 send_join_room 機制信
2. 改寫N92 send_review_room_apply 排程信
3. 改寫N94 send_room_promote 排程信
4. 配合產品更新替換文案與圖檔
5. 修正mail_type 6,7顛倒的錯誤
6. 將產出貼文預設圖片的部分抽成共用函式

# 寫入信件內容到檔案方便測試
import os
mail_dir = "./mail"
os.makedirs(mail_dir, exist_ok=True)
mail_type = "review_room_apply"
timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
file_path = (
    f"{mail_dir}/{mail_type}_{room_id}_{mail_data.pid}_{timestamp}.html"
)
with open(file_path, "w", encoding="utf-8") as f:
    f.write(content)
logger.info(f"emit_send_review_room_apply: 信件內容已寫入 {file_path}")
logger.info(
    f"emit_send_review_room_apply: 信件已發送, receiver_email={mail_data.email}, pid={mail_data.pid}, room_id={room_id}, template={template_name}"
)

## 需求&規則

## 作業流程
 
## 流程
### 主要 流程一
### 主要 流程二
 
## 開發範疇
### 後端
#### 後端task1
#### 後端task2

### 前端
#### 前端task1
#### 前端task2

### 上版注意

### 驗收注意

### 延伸議題

# prompt
## sonnet 4.5
### 1
我要做Java改寫，請幫我改寫
nabi/service/MiscServiceImpl.java裡的
sendJoinRoom、sendReviewRoomApply、sendRoomPromote，三隻寄件的API
1.請幫我改寫到python的 api_mail/mail_tasks.py
請參考emit_send_greet的形式，分別為他們建立一個寄件的mail task
2.他們三支原本都是透過API串接，串接實作components/e104/api/nabi/api.py
請幫我移除串接實作，並幫我把呼叫這些實作的應用節點改成呼叫這次改寫的函式
重點說明
1.python這邊有現有有寄信機制，請參考emit_send_greet的形式
2.信件對應的模板(.vm)也要搬到python對應的services/emails/templates
3.信件模板搬動要改成支援jinja2語法的html形式，基本做法請複製完整的vm到目標目錄並變更副檔名
最後再把現有的vm語法改成jinja2語法，注意不要簡化任何版型控制相關的內容，只處理變數替代的部分就好
### 2
1.join room 根review room 的信件模板，還有因為資料類型分類為子模型，會因為資料不同要套不同版，請幫我把所有相關的版型都複製並改寫
同時判斷資料套用不同版型的邏輯也要幫我改寫到python
2.你有分出兩個是ap信件放到api_ap/mail下是對的，但有sendJoinRoom是機制信，應該放到api_mail/mail_tasks.py
3.準備資料的函式目前看起來沒有共用性，可以放在mail_tasks.py裡面不用特別拉出來放到service裡面
4.放在api_mail/mail_tasks.py的函式，請幫我參考參考其他放在相同檔案有提供測試參數模式的方式實作
5.放在api_ap/mail/mail_tasks.py的函式，請幫我參考其他放在相同檔案有提供測試參數模式的方式實作
### 3
1. 請參考emit_send_greet的方式，用send_greet_open_mail_link的方式產生一個GA送事件url塞進信件model
2. 同時也幫我異動template裡的ga url埋設部分，也參考emit_send_greet的template，把新加入的url塞進去template裡面
3. 移除template裡舊的GA追蹤碼埋設
4. GA碼請參考Ga4MailType，review room是type_6, join room是type_7
### 4
1. 請幫我在api_mail/views.py生成三個寄信的api endpoint，分別對應到這次的三個寄信函式，讓我可以直接呼叫進行測試
### 5
請幫我在mail_tasks.emit_send_join_room、ap_mail_tasks.emit_send_review_room_apply、ap_mail_tasks.emit_send_room_promote
這三隻程式後面產生完mail的地方，幫我把後面寄信的先註解起來
並插入一段把信件內容寫入./mail/{mail_type}_{datetime}.html文件
方便我測試
### 6
我發現在取用ap_mail狀態的地方，用了錯誤的方式
請先閱讀這個函式api_mail/mail_tasks.py\emit_coupon_countdown_mail
然後依照這裡面的用法與pettern幫我review我們目前在處理的三個寄信函式
### 7
還有取得User資訊與mail的步驟也需要跟參考函式一致
>>>> 經過一番修改



# Log
========================================================