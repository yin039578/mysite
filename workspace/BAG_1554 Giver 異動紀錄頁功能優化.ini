https://104corp.atlassian.net/browse/GIVERFARM-1554

GIVERFARM-1554 [BAG後台]Giver異動紀錄頁功能優化
 
## 需求&規則
1.暱稱/現任職位/現任公司/自介/大頭照，異動時才去註記需要審閱
2.異動紀錄依照上次審閱結果作為判斷基準，若是異動回與上次異動結果相同，則更新待審閱狀態為不需審閱
 
## 流程
### 使用者資料異動
1.使用者異動欄位
1.1 在系統內異動(目前好像沒有這個情境了)
1.2 收到中台異動同步
2.判斷異動欄位是否包含在需審閱範圍，若否則不處理
3.判斷是否已有資料在使用者異動紀錄內，若有則更新資料，若無則新增一筆資料
4.判斷新的資料與上次審閱點是否相同，若相同則去更新待審閱清單為不需審閱，若不同則去更新待審閱清單為需審閱
 
### 使用者確認異動資料審閱
1.更新待審閱列表，改為不需審閱
2.新增一筆異動紀錄，紀錄異動後的結果
 
## 開發範疇
### 後端
#### 新增"使用者資料審閱紀錄"資料表-user_basic_change_approved_log > done
欄位：暱稱/現任職位/現任公司/簡介/大頭照/create_date/create_user
idx: pid
pkey: auto_increment
#### 異動"使用者異動記錄"資料表-user_basic_change_log > done
新增欄位用來記錄修改前與修改後的結果
新增欄位：原暱稱/原現任職位/原現任公司/原簡介/原大頭照/當前暱稱/當前現任職位/當前現任公司/當前簡介/當前大頭照
移除欄位，以後不做狀態更新，只會更新欄位最後
移除欄位：status
#### 調整 異動User資料表function > done
檢查是否有異動到需要審閱欄位，並進行資料更新
- 站內異動 > 確認沒有在用了，code先註解
- profile webhook異動 > 指定欄位才要進行審閱
- profile_photo webhook異動 > 指定欄位才要進行審閱
#### 調整 查詢審閱異動記錄API
取得單一User異動記錄，調整回應model，包含修改前後資料內容
#### 調整 審閱異動記錄API > done
審閱成功時寫入"使用者資料審閱紀錄"，並刪除用者異動紀錄
#### 新增 查詢"使用者資料審閱記錄"API
input: pid, ...分頁參數
output: 使用者資料審閱記錄列表，含完整內容 > 欄位不多且已經限定pid，情境上應該也不會太多

### 前端
確認相關功能都有寫cloudwatch access log > ip, csr, path, method等參數
#### 異動紀錄頁
1.在第一欄新增顯示modifydate，顯示格式yyyy/MM/dd
2.需比對回傳前後差異顯示欄位異動差異
3.現任公司暱稱等資料改抓資料內的after資訊
#### 異動檢視頁內
1.抓取使用者異動記錄API，取回前後差異內容
2.顯示使用者資料審閱紀錄列表
3.另外抓AC名稱呈現於畫面

### 上版注意
1. 第一次上版需先清除user_basic_change_log資料表內的非待審閱資料，之後都是需要審核的資料才會留存。可以加入migration檔案執行
``` sql
    delete from user_basic_change_log where status = 1;
```

### 驗收注意
1. 原本就是審閱中的資料不寫第一筆紀錄，代表前端會抓不到修改前紀錄，只有在初始化階段會有這個問題，都審閱過一次有紀錄就不會有沒呦修改前的情況
2. 大頭照是比對網址不是圖片，所有有更新一定要審，就算是原圖替換

### 延伸議題
1. 目前BAG後台有不少個資，但似乎沒有符合資安的log規定
2. webhook失敗retry機制是否應該觸發異動資料審核 > 先確認webhook完整機制

# prompt
### 調整 異動User資料表function 
我要進行調整 異動User資料表function這個任務，以下是說明
異動User資料表這個function被webhook呼叫後進行資料
這是兩個物件，分別是user model 與 profile model
api呼叫後解密取得profile model，此時會用相同Key去DB取回user model
進行資料比對後更新
我要在這邊加入這次新的判斷
1. 判斷是否有異動到需要審閱欄位，決定是否要進到新的流程的下一步
2. 如果有異動到需要審閱欄位，則要去user_basic_change_log資料表內查詢是否有這筆資料
3. 如果有這筆資料，則比對before的這給幾個欄位資料與當前最新的資料是否全部都完全相同
3.1 如果完全相同，則代表User異動回審閱前的結果，這個情況不需要審閱，刪除user_basic_change_log裡的異動紀錄
3.2 如果不完全相同，則代表User資料依然需要審閱，這個情況需要將現有取回的最新資料更新回user_basic_change_log資料表的after對應欄位
3.3 如果before資料完全空白，則代表這次版本更新前，User已經在待審狀態，所以沒有足以確認的before資訊，就當成有資訊變更，行為同3.2
4. 如果沒有這筆資料，則代表User資料需要審閱，且目前沒有待審閱資料，則新增一筆資料到user_basic_change_log資料表，用當前的資料放在before，需要更新的資料放在after

請告給我幾個對應的funtion，需要被拆出去的部分也請說明，但目前這個範疇判斷應該不需要另外抽出共用function

==== 以下是更新的funciton ====
==== 以下是user model ====
==== 以下是input model ====
==== 因為欄位有機敏資料，有一些內控機制處理，附上原本的更新資料function做參考 ====








# Log
========================================================
- PM初步討論可行性1hr
- 初步分析 拆解工項 1.5hr
- PM二次討論可行性1hr
- plan meeting 純這個項目 + 會後工程討論1hr
- 更新分析紀錄 0.5hr
- 確認工程運作 0.5hr 4/28
- 環境建置 2hr 4/28
- 環境建置,套件無法編譯問題、建立測試環境 3hr 4/29
- 4/30 開發 3.5h
- 5/5
    - 確認前端是否還有地方更新profile > 確認沒有，
    - migrate資料表，要移除不用審核的User資料
    - 完成審閱異動記錄API
- 5/6
    - 確認不用在審核通過時寫入紀錄
- 接續
    - 處理初期待審人的資料，要幫他們寫入after資料，或是上線前都審核完成
    - 確認萬一上線過程有人異動了資料會發生什麼事，用lab目前狀況來測試，local開發時改變了資料結構但lab沒有改變，收到wrbhook時會發生什麼事