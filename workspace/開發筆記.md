
# 開發筆記
- [開發筆記](#開發筆記)
- [總綱 - 整體架構說明](#總綱---整體架構說明)
- [python環境建置](#python環境建置)
  - [作業系統環境(mac)](#作業系統環境mac)
  - [步驟](#步驟)
    - [環境資訊與設計](#環境資訊與設計)
      - [額外說明](#額外說明)
    - [確認專案資訊](#確認專案資訊)
    - [建立venv與建制環境](#建立venv與建制環境)
    - [設定pycharm](#設定pycharm)
    - [設定postman](#設定postman)
- [SQL](#sql)
  - [migration](#migration)
    - [基本操作 \> local開發到上到環境](#基本操作--local開發到上到環境)
    - [退版](#退版)
    - [上版/降版失敗](#上版降版失敗)
      - [情境一：第一個步驟就失敗](#情境一第一個步驟就失敗)
      - [情境二：第一個步驟之後失敗](#情境二第一個步驟之後失敗)
    - [注意事項](#注意事項)
- [api框架](#api框架)
- [drtq框架](#drtq框架)
- [共用套件](#共用套件)
- [應用情境](#應用情境)
  - [cache](#cache)
  - [非同步運作](#非同步運作)
    - [server內](#server內)
    - [架構層](#架構層)
  - [發信/簡訊](#發信簡訊)
  - [統計與資料處理](#統計與資料處理)
  - [webhook](#webhook)
  - [資料匯出/資料匯入](#資料匯出資料匯入)
  - [年末凍結倒資料](#年末凍結倒資料)
  - [apim協作與api設定](#apim協作與api設定)
- [配合公司運作](#配合公司運作)
  - [AP管理運作](#ap管理運作)
  - [資安](#資安)
- [我的疑問](#我的疑問)

# 總綱 - 整體架構說明
- python api server
- python drtq server
- db service
- redis service
- run desk service

# python環境建置
## 作業系統環境(mac)
- brew: mac套件管理
- venv: python虛擬機，在多專案時獨立出開發測試環境 
- pyenv: python切換器，讓在一個作業系統內可以在多個python版本間切換

## 步驟
### 環境資訊與設計
- venv共用資料夾位置
  - /Users/yochao.yin/Documents/Projects/venv/{project}_{python_ver}
- pyenv python位置
  - /Users/yochao.yin/.pyenv/versions/{version}/bin/python{version}

#### 額外說明
因為python,pip的安裝與編譯有一段流程要跑，有時會使用到一些底層的lib做編譯，但是這些lib可能也有版本的議題，造成python,pip過新的時候會無法相容造成編譯錯誤，所以在尚未有時間處理版更的情況，安裝專案最好參考現有的作業環境

### 確認專案資訊
- python版本
  - 每個產品版本可能有落差，也會實質影響lib的依賴關係或是語法差異．要多注意
  - 若是一直發生編譯異常的狀況(Mac M3晶片)，可嘗試使用以下語法，他指定了編譯採用的資源，並重新編譯了python放在pyenv內
    - PYTHON_CONFIGURE_OPTS="--enable-framework --with-openssl=$(brew --prefix openssl@3)" pyenv install 3.9.21

- pip版本

### 建立venv與建制環境
- 建立venv
  - pycharm建立
    - 右下角點擊interpreter或是pycharm>setting>Project:{project}>interpreter
    - 選擇需要的python版本與資料夾
  - 指令建立
    - /Users/yochao.yin/.pyenv/versions/{version}/bin/python{version} -m venv /Users/yochao.yin/Documents/Projects/venv/{project}
- 進入venv
  - pycharm進入
    - 設定好interpreter
    - 開啟terminal
  - 指令進入
    - source source /Users/yochao.yin/Documents/Projects/venv/{venv project name}/bin/activate
- 確認python版本
  - python -V
  - 版本錯誤處理
    - 離開venv
    - 刪除venv資料夾
    - 確認pyenv是否有該python版本，若否則安裝，或重新編譯(上面環境處有重新編譯說明)
    - 重建venv
- 確認pip版本
  - pip -V
  - 版本錯誤處理
    -  python -m pip install --upgrade "pip=={version}"
  
### 設定pycharm

### 設定postman
1. 在python網站根目錄/openapi.json
2. 匯入postman
3. 建立環境，每個(產品+環境)為一組
4. 測試

# SQL 
- 使用的 ORM 框架是 SQLAlchemy
- 使用的 migration 工具是 Alembic
## migration
- 核心觀念
  - 每個專案內都有一個/migrate/versions資料夾，內容是每次DB異動的計劃書
  - 當DB重建，就是依序執行完全部版本的計劃書就能得到最終的版本
  - 每個專案計劃書版本是共用的，所以若是需要有兩個分支以上需要異動DB的話就要先協調好運作
- 技術細節
  - 每個migrate裡的描述檔裡都有兩個值：revision代表當前版本、down_revision代表上一個版本，DB裡有一個alembic_version table裡面記錄了當前版本，每次執行upgrade或downgrade都會比對，若是比對版本錯誤都會禁止操作，所以多人同時修改Model時要特別注意
### 基本操作 > local開發到上到環境
1. 異動程式資料表Model
2. 在terminal執行下列指令自動產生異動描述檔
``` cmd
  alembic revision --autogenerate
```
3. 去程式目錄檢查新建立的檔案，位於：/migrate/versions
   - 檢查所需執行項目是否符合預期
   - 需檢查upgrade/downgrade
   - 若是要增加其他在異動資料結構時，需同時進行的語法，可以在這邊加入
   - 若downgrade有預計的額外sql也要一起加入
4. 執行upgrade，讓local執行DB更新作業
```
alembic upgrade head
```
5. 上code到作業環境就會直接執行步驟4，請參考專案根目錄內CICD流程或專案內搜尋alembic
### 退版
1. 執行downgrade
```
alembic downgrade {down_version}
```

### 上版/降版失敗
注意！上版失敗代表code也推不上去
#### 情境一：第一個步驟就失敗
恭喜大大，跟沒有上過一樣，調整好檢查好就可以重上了
#### 情境二：第一個步驟之後失敗
代表有部分的語法執行成功，甚至資料異動了，那這種情境太多就不列舉，只討論操作面的原則
- 策略一 還原重做
  - 將已經執行的內容還原到執行前
  - 排除卡住的原因
  - 重新上版
- 策略二 接續執行
  - 將已執行的部分獨立成一個描述檔，建立一個描述檔將未執行的內容搬移過去
  - 將DB當前版本設定為已執行的那個版本號碼
  - 繼續上版

### 注意事項
- 無論upgrade, downgrade,都是DB操作，注意資料異動範疇，可能的資料面影響或效能面影響，需要備份也要再上版前請DBA(SRE)先處理
- 上版遇到版本Deadlock，參考Heybar、農場、中台，先停掉DRTQ服務再進行升版
- 不是用alembic建立的Table，或是不想用alembic管理的table把它放在modeul目錄下的outer_models.py裡
- [TODO] 上線migration有transaction沒有中斷，造成migration失敗 > 找yorick確認
# api框架
RESTFUL
CRUD
Pagination
annotation
fast api

# drtq框架

# 共用套件

# 應用情境
## cache

## 非同步運作
### server內
### 架構層

## 發信/簡訊

## 統計與資料處理

## webhook

## 資料匯出/資料匯入

## 年末凍結倒資料

## apim協作與api設定

# 配合公司運作
## AP管理運作
取號blabla登記那個流程

## 資安
Key管理運作

# 我的疑問
1. Depends與為什麼這個api要這樣寫
``` python
@router.post(
    '/profile',
    name="Webhook 同步 Profile",
    description="Webhook 同步 Profile",
    include_in_schema=False,
    response_model=SuccessModel[bool]
)
@log_func_args
def webhook_profile(data: bytes = Depends(get_body)):
    """
    Webhook 同步 Profile
    """
    # 取得公鑰
    key = Webhook.get_public_key()
    # 取得解密內容
    content = Webhook.get_decode_content(key, data)
    # dict 轉 serializers
    webhook_content_obj = ProfileWebhook(**content)
    result = True
    if webhook_content_obj.action == WebhookAction.UPDATE:
        result = webhook_sync_profile(webhook_content_obj.data)
    elif webhook_content_obj.action == WebhookAction.IMPORT_HEADSHOT:
        result = webhook_sync_profile_photo(webhook_content_obj.data)
    elif webhook_content_obj.action == WebhookAction.DELETE:
        result = webhook_sync_delete_profile(webhook_content_obj.data)

    return ApiOutputModel.serialize_success(result)
```