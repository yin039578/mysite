
# 後端開發筆記
- [後端開發筆記](#後端開發筆記)
- [python環境建置](#python環境建置)
  - [作業系統環境(mac)](#作業系統環境mac)
  - [步驟](#步驟)
    - [環境資訊與設計](#環境資訊與設計)
      - [額外說明](#額外說明)
    - [確認專案資訊](#確認專案資訊)
    - [建立venv與建制環境](#建立venv與建制環境)
    - [設定pycharm](#設定pycharm)
    - [設定vscode ide](#設定vscode-ide)
    - [安裝依賴套件](#安裝依賴套件)
      - [pip](#pip)
      - [poetry](#poetry)
    - [設定postman](#設定postman)
- [SQL](#sql)
  - [migration](#migration)
    - [基本操作 \> local開發到上到環境](#基本操作--local開發到上到環境)
    - [退版](#退版)
    - [上版/降版失敗](#上版降版失敗)
      - [情境一：第一個步驟就失敗](#情境一第一個步驟就失敗)
      - [情境二：第一個步驟之後失敗](#情境二第一個步驟之後失敗)
    - [注意事項](#注意事項)
- [目錄規劃](#目錄規劃)
- [api框架](#api框架)
  - [路由規劃](#路由規劃)
    - [by folder](#by-folder)
    - [by type](#by-type)
- [drtq框架](#drtq框架)
  - [監控](#監控)
- [共用套件](#共用套件)
- [基礎建設](#基礎建設)
  - [log](#log)
- [應用情境](#應用情境)
  - [cache](#cache)
  - [非同步運作](#非同步運作)
    - [server內](#server內)
    - [架構層](#架構層)
  - [發信/簡訊](#發信簡訊)
    - [活動吧](#活動吧)
      - [遇到的問題](#遇到的問題)
  - [統計與資料處理](#統計與資料處理)
  - [webhook](#webhook)
  - [資料匯出/資料匯入](#資料匯出資料匯入)
  - [年末凍結倒資料](#年末凍結倒資料)
  - [apim協作與api設定](#apim協作與api設定)
- [維運運作](#維運運作)
  - [上線的退版計劃](#上線的退版計劃)
- [配合公司運作](#配合公司運作)
  - [AP管理運作](#ap管理運作)
  - [資安](#資安)
- [開發取捨與思考](#開發取捨與思考)
- [參考資料與延伸整理筆記](#參考資料與延伸整理筆記)
- [我的疑問](#我的疑問)

# python環境建置
## 作業系統環境(mac)
- brew: mac套件管理
- pyenv: python切換器，讓在一個作業系統內可以在多個python版本間切換
- venv: python虛擬機，在多專案時獨立出開發測試環境
- poetry: python套件管理工具，提供虛擬環境、套件安裝、版本管理等功能
- postman: api測試工具，提供api測試、文件生成、環境管理等功能
- vscode: 輕量級編輯器，提供python開發環境含debugger


## 步驟 
### 環境資訊與設計
- pyenv python位置
  - /Users/yochao.yin/.pyenv/versions/{version}/bin/python{version}

#### 額外說明
因為python,pip的安裝與編譯有一段流程要跑，有時會使用到一些底層的lib做編譯，但是這些lib可能也有版本的議題，造成python,pip過新的時候會無法相容造成編譯錯誤，所以在尚未有時間處理版更的情況，安裝專案最好參考現有的作業環境

### 確認專案資訊
- python版本
  - 每個產品版本可能有落差，也會實質影響lib的依賴關係或是語法差異．要多注意
  - 若是一直發生編譯異常的狀況(Mac M3晶片)，可嘗試使用以下語法，他指定了編譯採用的資源，並重新編譯了python放在pyenv內
    - PYTHON_CONFIGURE_OPTS="--enable-framework --with-openssl=$(brew --prefix openssl@3)" pyenv install 3.9.21
- pip版本

### 建立venv與建制環境
- 建立venv 下面方式挑一種即可，建議用poetry建立
  - poetry建立 [安裝說明](https://holistic-flock-138.notion.site/poetry-b57bdac1993f44efbadbe94d5ad43f9f)
    - 若是要使用poetry作為套件管理工具，建議也使用peotry建立虛擬環境
    - poetry只支援放在他的預設目錄或是專案目錄，無法另外指定路徑
  - 指令建立
    - /Users/yochao.yin/.pyenv/versions/{version}/bin/python{version} -m venv /Users/yochao.yin/Documents/Projects/venv/{project}
  - pycharm建立
    - 右下角點擊interpreter或是pycharm>setting>Project:{project}>interpreter
    - 選擇需要的python版本與資料夾(python版本參考專案docker file)
    - 若是從這邊建立會卡住無法自己安裝指定版本的python，可以用pyenv/poetry建立好venv後回來指定

- 進入venv 下面看開發方式決定用哪一個
  - vscode進入
    - 若之前有設定過建議先清除：cmd + shift + p > Python: Clear Workspace Interpreter Setting
    - 從settings.json設定好interpreter，注意設定層級user > workspace
      - 依據個人專案使用方式設定好："python.defaultInterpreterPath"/"python.terminal.activateEnvironment"
    - 設定好後開啟任意python檔案，點擊右下角interpreter，選擇**user python from "python.defaultInterpreterPath" setting**，這邊順便檢查是否是剛才指定的目錄
    - 開啟terminal，注意terminal的python版本是否正確且自動載入venv
  - pycharm進入
    - 設定好interpreter
    - 開啟terminal
  - 指令進入
    - source source /Users/yochao.yin/Documents/Projects/venv/{venv project name}/bin/activate
- 確認python版本
  - python -V
  - 版本錯誤處理
    - 離開venv
    - 刪除venv資料夾
    - 確認pyenv是否有該python版本，若否則安裝，或重新編譯(上面環境處有重新編譯說明)
    - 重建venv
    - 重新設定IDE的interpreter
- 確認pip版本
  - pip -V
  - 版本錯誤處理
    -  python -m pip install --upgrade "pip=={version}"
  
### 設定pycharm
- 上面venv相關設定請參考上面的說明，確認開啟terminal時有正確載入venv即可
- debugger不用另外設定

### 設定vscode ide
- venv相關設定請參考上面的說明，確認開啟terminal時有正確載入venv即可
- 在專案目錄建立.vscode/launch.json，以下是debugger設定範例
  - 
```
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "API Server",
            "type": "python",
            "request": "launch",
            "program": "${workspaceFolder}/local.py",
            "console": "integratedTerminal",
            "envFile": "${workspaceFolder}/.env"
        },
        {
            "name": "Dramatiq Worker",
            "type": "python",
            "request": "launch",
            "module": "dramatiq",
            "args": [
                "app.dramatiq:broker",
                "--watch",
                "."
            ],
            "envFile": "${workspaceFolder}/.env",
            "console": "integratedTerminal"
        }
    ],
    "compounds": [
        {
            "name": "Run API and Worker",
            "configurations": [
                "API Server",
                "Dramatiq Worker"
            ],
            "stopAll": true // optional: 若其中一個結束就全部終止
        }
    ]
}
```
- 在左邊的debug功能點開展開的側邊欄，要選擇新建立的配置"Run API and Worker"，run debugger就可以同時啟動 API server與Dramatiq worker，並且可以在程式碼斷點處停下來進行debugger

### 安裝依賴套件
#### pip
- 安裝依賴套件，有的專案不只一個檔案，要自己注意
  - pip install -r requirements.txt
  - pip install -r r2.txt
#### poetry
- 因為poetry同時會幫你管venv，建議直接取用poetry建立venv
https://holistic-flock-138.notion.site/poetry-b57bdac1993f44efbadbe94d5ad43f9f

### 設定postman
1. 在python網站根目錄/openapi.json
2. 匯入postman
3. 建立環境，每個(產品+環境)為一組
4. 測試

# SQL 
- 使用的 ORM 框架是 SQLAlchemy
- 使用的 migration 工具是 Alembic
## migration
- 核心觀念
  - 每個專案內都有一個/migrate/versions資料夾，內容是每次DB異動的計劃書
  - 當DB重建，就是依序執行完全部版本的計劃書就能得到最終的版本
  - 每個專案計劃書版本是共用的，所以若是需要有兩個分支以上需要異動DB的話就要先協調好運作
- 技術細節
  - 每個migrate裡的描述檔裡都有兩個值：revision代表當前版本、down_revision代表上一個版本，DB裡有一個alembic_version table裡面記錄了當前版本，每次執行upgrade或downgrade都會比對，若是比對版本錯誤都會禁止操作，所以多人同時修改Model時要特別注意
### 基本操作 > local開發到上到環境
1. 異動程式資料表Model
2. 在terminal執行下列指令自動產生異動描述檔
``` cmd
  alembic revision --autogenerate
```
3. 去程式目錄檢查新建立的檔案，位於：/migrate/versions
   - 檢查所需執行項目是否符合預期
   - 需檢查upgrade/downgrade
   - 若是要增加其他在異動資料結構時，需同時進行的語法，可以在這邊加入
   - 若downgrade有預計的額外sql也要一起加入
4. 執行upgrade，讓local執行DB更新作業
```
alembic upgrade head
```
5. 上code到作業環境就會直接執行步驟4，請參考專案根目錄內CICD流程或專案內搜尋alembic
### 退版
1. 執行downgrade
```
alembic downgrade {down_version}
```

### 上版/降版失敗
注意！上版失敗代表code也推不上去
#### 情境一：第一個步驟就失敗
恭喜大大，跟沒有上過一樣，調整好檢查好就可以重上了
#### 情境二：第一個步驟之後失敗
代表有部分的語法執行成功，甚至資料異動了，那這種情境太多就不列舉，只討論操作面的原則
- 策略一 還原重做
  - 將已經執行的內容還原到執行前
  - 排除卡住的原因
  - 重新上版
- 策略二 接續執行
  - 將已執行的部分獨立成一個描述檔，建立一個描述檔將未執行的內容搬移過去
  - 將DB當前版本設定為已執行的那個版本號碼
  - 繼續上版

### 注意事項
- 無論upgrade, downgrade,都是DB操作，注意資料異動範疇，可能的資料面影響或效能面影響，需要備份也要再上版前請DBA(SRE)先處理
- 上版遇到版本Deadlock，參考Heybar、農場、中台，先停掉DRTQ服務再進行升版
- 不是用alembic建立的Table，或是不想用alembic管理的table要另外處理
TODO:上線migration有transaction沒有中斷，造成migration失敗 > 找yorick確認

# 目錄規劃
參考[文件](https://codimd.104.com.tw/kXPxZ4i8T6CxVA6NtBmDQA?book=kXPxZ4i8T6CxVA6NtBmDQA)
- components 可以重複用，且避免任何客製化行為，如API引用，但不做任何加工
- services 實際引用上面的components，並且做客製化行為，如API引用、資料處理等，包含商務邏輯的部分，且可以共用
- 

# api框架
RESTFUL
CRUD
Pagination
annotation
fast api
## 路由規劃
### by folder
- 透過folder多層結構來規劃路由，例如api_crm/ad/featured_exam/actions.py，ad、featured_exam就是folder這樣可以讓路由結構更清晰
### by type
- api_profiles/actions/profile.py, api_profiles/actions/search.py這兩個檔案就是以type來規劃路由，這樣可以讓同一個功能的相關路由集中在一起，方便維護與查找。要再往下更多層就需要透過view去設定


# drtq框架
- 在
## 監控
- path: {api domain}/drama
有做好整合有簡易工具可以在api server上，可以有Dashboard可以看裡面的worker與queue裡的任務
https://blog.csdn.net/gitblog_00055/article/details/139673191


# 共用套件

# 基礎建設
## log 
用原生的python logging套件，並且有一個設定檔案
分別在啟用api server與drtq server時載入設定檔案
- 初始化時，每個專案也有一點落差，若找不到請搜尋logging.config.dictConfig
  - 啟用api server(以BAG為例)：app/main.py
  - 啟用drtq server(以BAG為例)：app/dramatiq.py
- 設定檔案：settings/logging.py
- [參考文件](https://docs.python.org/zh-tw/3.9/library/logging.config.html#logging-config-dictschema)
  


# 應用情境
## cache

## 非同步運作
### server內
### 架構層

## 發信/簡訊
### 活動吧
運作方式：API呼叫去觸發task，由一個主要的task去撈出全部的內容，然後緩慢執行，慢慢把要發信的內容發到執行發信的task
#### 遇到的問題
- 因為auto scaling的機制，當機器減量時，萬一把主要發信的task給關掉了，會導致該task被認定沒有完成，所以新的機器會重新接到這個task，導致重複發信
  - 解決方式：在主要發信的task裡面，先檢查該批次是否已否有已發送的內容，篩選掉後繼續發送

## 統計與資料處理

## webhook

## 資料匯出/資料匯入

## 年末凍結倒資料

## apim協作與api設定

# 維運運作
## 上線的退版計劃
因為產品流量與使用者增加，透過pr重新部署退版，再加上三個環境測試堆疊的時間會過長(每個環境10min CICD，至少多30min)
所以再來會有一個上線的退版計劃，當上線後發現有問題時，可以快速的回到上線前的狀態，並請SRE協助還原上一版image
TODO: 執行細節待議2025/7/7

# 配合公司運作
## AP管理運作
取號blabla登記那個流程

## 資安
Key管理運作

# 開發取捨與思考
1. 引用外部資源是否一定要透過後端？
    有取用DB資料的一定由後端處理；呼叫API後有產品流程、規格在其中或是複雜資料處理的API在後端處理，讓前端專注在UI就好。純顯示資料，或是規則不重要且不會重複應用就可以讓前端處理。

# 參考資料與延伸整理筆記
https://codimd.104.com.tw/kXPxZ4i8T6CxVA6NtBmDQA?book=kXPxZ4i8T6CxVA6NtBmDQA

# 我的疑問
1. Depends與為什麼這個api要這樣寫
``` python
@router.post(
    '/profile',
    name="Webhook 同步 Profile",
    description="Webhook 同步 Profile",
    include_in_schema=False,
    response_model=SuccessModel[bool]
)
@log_func_args
def webhook_profile(data: bytes = Depends(get_body)):
    """
    Webhook 同步 Profile
    """
    # 取得公鑰
    key = Webhook.get_public_key()
    # 取得解密內容
    content = Webhook.get_decode_content(key, data)
    # dict 轉 serializers
    webhook_content_obj = ProfileWebhook(**content)
    result = True
    if webhook_content_obj.action == WebhookAction.UPDATE:
        result = webhook_sync_profile(webhook_content_obj.data)
    elif webhook_content_obj.action == WebhookAction.IMPORT_HEADSHOT:
        result = webhook_sync_profile_photo(webhook_content_obj.data)
    elif webhook_content_obj.action == WebhookAction.DELETE:
        result = webhook_sync_delete_profile(webhook_content_obj.data)

    return ApiOutputModel.serialize_success(result)
```